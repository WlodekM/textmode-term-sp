<!DOCTYPE html>
<html>
    <head>
        <title>textmode // terminal</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@latest/css/xterm.css" />
        <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@latest/lib/xterm.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@latest/lib/xterm-addon-attach.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@latest/lib/addon-fit.js"></script>
        <link rel="stylesheet" href="./textmode.css" />
        <style>
            body {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            #terminal {
                flex-grow: 1;
            }
        </style>
    </head>
    <body>
        <div id="terminal"></div>
        <div style="text-align:right">
            <a href="https://cd5k.net/tau/">&tau;</a>
        </div>
        <script type="module">
            import system from "./term/mksys.ts"
            import NYA from './term/nya.ts';
            const term = new NYA(system, 2)
            // mak terminal
            const terminal = new Terminal({convertEol: true});
            const fitAddon = new FitAddon.FitAddon();
            window.onresize = function(event) {
                fitAddon.fit();
            };
            terminal.loadAddon(fitAddon);
            
        
            // uh terminal now displays yippee
            terminal.open(document.getElementById('terminal'));
            fitAddon.fit();  // resize terminale
        
            printf(`  ,-.       _,---._ __  / \\\r
 /  )    .-'       \`./ /   \\\r
(  (   ,'            \`/    /|\r
 \\  \`-"             \\'\\   / |\r
  \`.              ,  \\ \\ /  |\r
   /\`.          ,'-\`----Y   |\r
  (            ;        |   '\r
  |  ,-.    ,-'         |  /\r
  |  | (   |        hjw | /\r
  )  |  \\  \`.___________|/\r
  \`--'   \`--'\r

welcome.`)
            prompt();
            terminal.write('figlet textmode');
            printf(`\r
\r _            _                       _
\r| |_ _____  _| |_ _ __ ___   ___   __| | ___
\r| __/ _ \\ \\/ / __| '_ \` _ \\ / _ \\ / _\` |/ _ \\
\r| ||  __/>  <| |_| | | | | | (_) | (_| |  __/
\r \\__\\___/_/\\_\\\\__|_| |_| |_|\\___/ \\__,_|\\___|`)
            prompt();
        
            // Handle user input
            terminal.onData(e => {
                if (wsSshMode) {
                    ws.send(e)
                    return;
                }
                if (e === '\r') {  // Enter key pressed
                    const [command, ...argv] = currentInput.split(' ')
                    terminal.write('\n'); // Newline after command
                    let foundCommand = Object.entries(commands).find(([cn, c]) => cn == command || c.aliases.includes(command))
                    foundCommand = foundCommand ? foundCommand[1] :
                        {
                            fn: () => terminal.write(`Unknown command: ${command}`)  // Handle unknown commands
                        }
                    
                    let noprompt = foundCommand.fn(argv)
                    
                    currentInput = '';
                    if(!noprompt) prompt();
                } else if (e === '\u007F') {  // Handle backspace (DEL)
                    if (currentInput.length > 0) {
                        currentInput = currentInput.slice(0, -1);  // Remove last character from input
                        terminal.write('\b \b');  // Simulate backspace in terminal
                    }
                } else if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
                    currentInput += e;
                    terminal.write(e);
                }
            });
        </script>
    </body>
</html>